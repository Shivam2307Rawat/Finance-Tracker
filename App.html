<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker - HTML Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 equivalent */
        }
        .content-section {
            display: none; /* Hidden by default, shown by JS */
        }
        .content-section.active {
            display: block;
        }
        /* Custom styles for elements that might be harder to style with pure Tailwind in JS or for consistency */
        .form-input, .form-select {
            border-width: 1px;
            border-color: #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 0.875rem;    /* text-sm */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            width: 100%;
        }
        .form-input:focus, .form-select:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* focus:ring-blue-500 */
            outline: none;
        }
        .button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem;    /* text-sm */
            font-weight: 500;       /* font-medium */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .button-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        .button-primary:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .button-primary:disabled {
            background-color: #93c5fd; /* bg-blue-300 */
            cursor: not-allowed;
        }
        .button-secondary {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            border: 1px solid #d1d5db; /* border-gray-300 */
        }
        .button-secondary:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-lg */
            width: 90%;
            max-width: 500px; /* md:max-w-md */
        }
        .editing-row {
            background-color: #eff6ff !important; /* bg-blue-50 */
        }
        .editing-row td {
            padding: 0 !important;
        }
        .editing-row td > div {
            padding: 1rem 1.5rem; /* p-4 md:p-6 */
        }
        /* Chart container fixed height to prevent layout shifts if data is empty */
        .chart-wrapper {
            background-color: #fff;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);  /* shadow-md */
            padding: 1.5rem;      /* p-6 */
            min-height: 300px; /* Ensure a minimum height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-wrapper canvas {
            max-width: 100%;
            max-height: 400px; /* Adjust as needed */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container">
        <header id="app-header-container" class="bg-white shadow sticky top-0 z-50"></header>
        <main id="app-main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"></main>
        <footer id="app-footer-container" class="bg-white border-t border-gray-200 py-4 mt-8"></footer>
    </div>

    <div id="transaction-form-modal" class="modal" style="display: none;">
        <div id="transaction-form-modal-content" class="modal-content"></div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        let activeTab = 'dashboard';
        let transactions = [];
        if (transactions.length === 0) {
            // Add sample data for first-time users
            transactions = [
                { id: generateId(), date: '2025-05-20', description: 'Salary', category: 'salary', amount: 1200000, type: 'income' },
                { id: generateId(), date: '2025-05-21', description: 'Groceries', category: 'food', amount: 2500, type: 'expense' },
                { id: generateId(), date: '2025-05-22', description: 'Electricity Bill', category: 'utilities', amount: 1500, type: 'expense' },
                { id: generateId(), date: '2025-05-23', description: 'Freelance Project', category: 'side-hustle', amount: 20000, type: 'income' },
                { id: generateId(), date: '2025-05-24', description: 'Movie Night', category: 'entertainment', amount: 800, type: 'expense' }
            ];
        }
        console.log("Initial transactions state (should be empty):", JSON.parse(JSON.stringify(transactions)));

        let editingTransactionId = null; 
        let globalFormInitialValues = {}; 
        let globalFormIsEdit = false; 

        let currentFilters = { startDate: '', endDate: '', category: 'all', type: 'all', searchTerm: '' };
        let currentSort = { by: 'date', direction: 'desc' };

        const incomeCategories = ['salary', 'investment', 'side-hustle', 'gift', 'other'];
        const expenseCategories = ['food', 'transportation', 'housing', 'utilities', 'entertainment', 'health', 'education', 'shopping', 'debt', 'savings', 'other'];
        const allTransactionCategories = [...new Set([...incomeCategories, ...expenseCategories])];

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount, currency = 'INR') => new Intl.NumberFormat('en-IN', { style: 'currency', currency: currency }).format(amount);
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00Z'); // Treat as UTC for display consistency
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' });
        };
        
        const getISODate = (dateInput) => {
            let dateObj;
            if (!dateInput) { 
                dateObj = new Date(); // Default to today for new transactions if no date is provided
            } else if (dateInput instanceof Date) {
                dateObj = dateInput;
            } else { 
                const parts = String(dateInput).split('T')[0].split('-');
                if (parts.length === 3 && parts.every(p => !isNaN(parseInt(p,10)))) {
                    dateObj = new Date(Date.UTC(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)));
                } else {
                    dateObj = new Date(dateInput); // Fallback, might be less reliable for ambiguous strings
                }
            }

            if (isNaN(dateObj.getTime())) { 
                console.warn("getISODate: Invalid dateInput, defaulting to today.", dateInput);
                dateObj = new Date(); 
            }
            
            const year = dateObj.getUTCFullYear();
            const month = ('0' + (dateObj.getUTCMonth() + 1)).slice(-2);
            const day = ('0' + dateObj.getUTCDate()).slice(-2);
            return `${year}-${month}-${day}`;
        };


        const generateId = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        const getCategoryColorHex = (category) => {
            const colorMap = { 
                salary: '#3B82F6', investment: '#10B981', 'side-hustle': '#8B5CF6', gift: '#F472B6',
                food: '#F59E0B', transportation: '#6366F1', housing: '#EC4899', utilities: '#64748B',
                entertainment: '#F97316', health: '#14B8A6', education: '#8B5CF6', shopping: '#EF4444',
                debt: '#9CA3AF', savings: '#10B981', other: '#6B7280',
            };
            return colorMap[String(category).toLowerCase().replace(/ /g, '-')] || '#6B7280';
        };
        
        // --- DATA CALCULATION FUNCTIONS ---
        function calculateBalanceSummary() {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            return { balance: totalIncome - totalExpense, income: totalIncome, expense: totalExpense };
        }
        function calculateCategoryBreakdown(type) {
            const relevantTransactions = transactions.filter(t => t.type === type);
            const totalAmount = relevantTransactions.reduce((sum, t) => sum + t.amount, 0);
            if (totalAmount === 0) return [];
            const breakdown = relevantTransactions.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            return Object.entries(breakdown).map(([category, amount]) => ({ category, amount, percentage: (amount / totalAmount) * 100 })).sort((a, b) => b.amount - a.amount);
        }
        function generatePieChartDataJS(type) {
            const breakdown = calculateCategoryBreakdown(type);
            return {
                labels: breakdown.map(item => item.category.charAt(0).toUpperCase() + item.category.slice(1).replace('-', ' ')),
                datasets: [{ label: type.charAt(0).toUpperCase() + type.slice(1), data: breakdown.map(item => item.amount), backgroundColor: breakdown.map(item => getCategoryColorHex(item.category)), borderColor: breakdown.map(item => getCategoryColorHex(item.category)), borderWidth: 1 }]
            };
        }
        function generateTimeSeriesChartDataJS() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = transactions.reduce((acc, t) => {
                const dateObj = new Date(t.date + 'T00:00:00Z');
                const month = dateObj.getUTCMonth(); const year = dateObj.getUTCFullYear();
                const key = `${year}-${months[month]}`;
                if (!acc[key]) acc[key] = { income: 0, expense: 0, date: new Date(Date.UTC(year, month, 1)) };
                if (t.type === 'income') acc[key].income += t.amount; else acc[key].expense += t.amount;
                return acc;
            }, {});
            const sortedKeys = Object.keys(monthlyData).sort((a,b) => monthlyData[a].date - monthlyData[b].date);
            return {
                labels: sortedKeys,
                datasets: [
                    { label: 'Income', data: sortedKeys.map(key => monthlyData[key].income), borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: false, tension: 0.1 },
                    { label: 'Expenses', data: sortedKeys.map(key => monthlyData[key].expense), borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: false, tension: 0.1 }
                ]
            };
        }
        function getFilteredAndSortedTransactions() {
            let processedTransactions = [...transactions]; 
            if (currentFilters.startDate) { const sd = new Date(currentFilters.startDate + 'T00:00:00Z').getTime(); processedTransactions = processedTransactions.filter(t => new Date(t.date + 'T00:00:00Z').getTime() >= sd); }
            if (currentFilters.endDate) { const ed = new Date(currentFilters.endDate + 'T00:00:00Z').getTime(); processedTransactions = processedTransactions.filter(t => new Date(t.date + 'T00:00:00Z').getTime() <= ed); }
            if (currentFilters.category !== 'all') processedTransactions = processedTransactions.filter(t => t.category === currentFilters.category);
            if (currentFilters.type !== 'all') processedTransactions = processedTransactions.filter(t => t.type === currentFilters.type);
            if (currentFilters.searchTerm) { const term = currentFilters.searchTerm.toLowerCase(); processedTransactions = processedTransactions.filter(t => String(t.description).toLowerCase().includes(term) || String(t.category).toLowerCase().includes(term)); }
            processedTransactions.sort((a, b) => {
                let comp = 0;
                if (currentSort.by === 'date') comp = new Date(a.date).getTime() - new Date(b.date).getTime();
                else if (currentSort.by === 'amount') comp = a.amount - b.amount;
                return currentSort.direction === 'asc' ? comp : -comp;
            });
            return processedTransactions;
        }

        // --- CRUD OPERATIONS ---
        function addTransaction(data) {
            console.log("ADD_TRANSACTION_START: Received data:", JSON.parse(JSON.stringify(data)));
            const newTransaction = { ...data, id: generateId(), date: getISODate(data.date) };
            transactions.unshift(newTransaction);
            console.log("ADD_TRANSACTION_END: transactions array length:", transactions.length, "New transaction ID:", newTransaction.id);
            console.log("Current full transactions array (after add):", JSON.parse(JSON.stringify(transactions)));
            editingTransactionId = null; 
            closeTransactionFormModal(); 
            renderApp();
        }

        function updateTransaction(id, updatedData) {
            console.log("UPDATE_TRANSACTION_START: ID:", id, "Received data:", JSON.parse(JSON.stringify(updatedData)));
            transactions = transactions.map(t => t.id === id ? { ...t, ...updatedData, id: t.id, date: getISODate(updatedData.date) } : t);
            console.log("UPDATE_TRANSACTION_END: transactions array updated for ID:", id);
            editingTransactionId = null; 
            closeTransactionFormModal(); 
            renderApp();
        }

        function deleteTransaction(id) {
            console.log("DELETE_TRANSACTION_START: ID:", id);
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                if (editingTransactionId === id) editingTransactionId = null;
                console.log("DELETE_TRANSACTION_END: Transaction deleted. New length:", transactions.length);
                renderApp();
            } else {
                console.log("DELETE_TRANSACTION_CANCELLED: ID:", id);
            }
        }

        // --- UI RENDERING FUNCTIONS ---
        function renderHeader() {
            const headerContainer = document.getElementById('app-header-container');
            const navItems = [
                { name: 'Dashboard', value: 'dashboard', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>` },
                { name: 'Transactions', value: 'transactions', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>` },
                { name: 'Charts', value: 'charts', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>` },
                { name: 'Add Transaction', value: 'add-transaction-page', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>` },
            ];
            let navHTML = navItems.map(item => `<button data-tab="${item.value}" class="nav-button flex items-center px-3 py-2 text-sm font-medium rounded-md ${activeTab === item.value ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:text-blue-600 hover:bg-blue-50'} transition-colors duration-200"><span class="mr-2">${item.icon}</span> ${item.name}</button>`).join('');
            let mobileSelectHTML = `<select id="mobile-nav-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">${navItems.map(item => `<option value="${item.value}" ${activeTab === item.value ? 'selected' : ''}>${item.name}</option>`).join('')}</select>`;
            headerContainer.innerHTML = `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4"><div class="flex justify-between items-center"><div class="flex items-center"><span class="text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></span><h1 class="ml-3 text-xl font-bold text-gray-900">Financial Tracker</h1></div><nav class="hidden md:flex space-x-4">${navHTML}</nav><div class="md:hidden w-full max-w-xs">${mobileSelectHTML}</div></div></div>`;
            headerContainer.querySelectorAll('.nav-button').forEach(button => button.addEventListener('click', (e) => setActiveTab(e.currentTarget.dataset.tab)));
            const mobileNav = document.getElementById('mobile-nav-select');
            if(mobileNav) mobileNav.addEventListener('change', (e) => setActiveTab(e.target.value));
        }
        function renderFooter() {
            document.getElementById('app-footer-container').innerHTML = `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><p class="text-center text-sm text-gray-500">Financial Tracker &copy; ${new Date().getFullYear()} | Keep track of your finances wisely</p></div>`;
        }
        function renderDashboardPage() {
            const section = document.getElementById('dashboard-section'); 
            if (!section) return;
            const summary = calculateBalanceSummary();
            const expensesBreakdown = calculateCategoryBreakdown('expense').slice(0, 5);
            const incomeBreakdown = calculateCategoryBreakdown('income').slice(0, 5);
            const recentTransactions = getFilteredAndSortedTransactions().slice(0,5);
            const savingsRate = summary.income > 0 ? `${Math.round(((summary.income - summary.expense) / summary.income) * 100)}%` : '0%';
            const summaryCardsHTML = `<div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-4"> <div class="bg-white rounded-lg shadow p-6 transform transition-all duration-300 hover:shadow-lg"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg></div><div><p class="text-sm font-medium text-gray-600">Current Balance</p><h3 class="text-2xl font-bold ${summary.balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(summary.balance)}</h3></div></div></div> <div class="bg-white rounded-lg shadow p-6 transform transition-all duration-300 hover:shadow-lg"><div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></div><div><p class="text-sm font-medium text-gray-600">Total Income</p><h3 class="text-2xl font-bold text-green-600">${formatCurrency(summary.income)}</h3></div></div></div> <div class="bg-white rounded-lg shadow p-6 transform transition-all duration-300 hover:shadow-lg"><div class="flex items-center"><div class="p-3 rounded-full bg-red-100 text-red-600 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg></div><div><p class="text-sm font-medium text-gray-600">Total Expenses</p><h3 class="text-2xl font-bold text-red-600">${formatCurrency(summary.expense)}</h3></div></div></div> <div class="bg-white rounded-lg shadow p-6 transform transition-all duration-300 hover:shadow-lg"><div class="flex items-center"><div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg></div><div><p class="text-sm font-medium text-gray-600">Savings Rate</p><h3 class="text-2xl font-bold text-purple-600">${savingsRate}</h3></div></div></div></div>`;
            const breakdownToHTML = (title, data) => { let items = data.length > 0 ? data.map(item => `<div class="flex items-center justify-between"><div class="flex items-center"><div class="w-3 h-3 rounded-full mr-3" style="background-color: ${getCategoryColorHex(item.category)};"></div><span class="text-sm font-medium text-gray-700">${String(item.category).charAt(0).toUpperCase() + String(item.category).slice(1).replace('-', ' ')}</span></div><div class="flex items-center"><span class="text-sm font-semibold text-gray-900 mr-2">${formatCurrency(item.amount)}</span><span class="text-xs text-gray-500">(${item.percentage.toFixed(1)}%)</span></div></div>`).join('') : `<p class="text-gray-500 text-sm">No data available.</p>`; return `<div class="bg-white rounded-lg shadow p-6"><h3 class="text-lg font-medium text-gray-900 mb-4">${title}</h3><div class="space-y-4">${items}</div></div>`; };
            const breakdownsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${breakdownToHTML('Top Expenses', expensesBreakdown)}${breakdownToHTML('Top Income Sources', incomeBreakdown)}</div>`;
            section.innerHTML = `<h2 class="text-2xl font-bold text-gray-900">Dashboard</h2> ${summaryCardsHTML} ${breakdownsHTML} <div class="mt-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-900">Recent Transactions</h3><button id="dashboard-add-transaction-btn" class="button button-primary">Add Transaction</button></div><div id="dashboard-recent-transactions-list"></div> ${transactions.length > 5 ? `<div class="mt-4 text-center"><button id="view-all-transactions-link" class="text-blue-600 hover:text-blue-800 font-medium">View All Transactions</button></div>` : ''}</div>`;
            renderTransactionList('dashboard-recent-transactions-list', recentTransactions, true);
            const addBtn = document.getElementById('dashboard-add-transaction-btn'); if(addBtn) addBtn.addEventListener('click', () => openTransactionFormModal(null, false));
            if (transactions.length > 5) { const viewAllLink = document.getElementById('view-all-transactions-link'); if(viewAllLink) viewAllLink.addEventListener('click', () => setActiveTab('transactions')); }
        }
        function renderTransactionsPage() {
            const section = document.getElementById('transactions-section'); if (!section) return;
            section.innerHTML = `<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-gray-900">Transactions</h2><div class="flex space-x-3"><div id="export-button-container-transactions"></div><button id="transactions-add-transaction-btn" class="button button-primary">Add Transaction</button></div></div><div id="transaction-filter-container" class="mb-6"></div><div id="transaction-list-container-full"></div>`;
            renderTransactionFilter('transaction-filter-container');
            renderTransactionList('transaction-list-container-full', getFilteredAndSortedTransactions());
            renderExportButton('export-button-container-transactions', getFilteredAndSortedTransactions());
            const addBtn = document.getElementById('transactions-add-transaction-btn'); if(addBtn) addBtn.addEventListener('click', () => openTransactionFormModal(null, false));
        }
        let expensePieChartInstance, incomePieChartInstance, timeSeriesChartInstance; 
        function renderChartsPage() {
            const section = document.getElementById('charts-section'); if (!section) return;
            section.innerHTML = `<h2 class="text-2xl font-bold text-gray-900 mb-6">Financial Charts</h2><div class="grid grid-cols-1 gap-6 lg:grid-cols-2"><div class="lg:col-span-2 chart-wrapper"><h3 class="text-xl font-semibold text-gray-700 mb-4 self-start">Income vs Expenses Over Time</h3><canvas id="timeSeriesChartCanvas"></canvas><p id="timeSeriesChartCanvas-nodata" class="text-gray-500" style="display:none;">No data available</p></div><div class="chart-wrapper"><h3 class="text-xl font-semibold text-gray-700 mb-4 self-start">Expense Breakdown</h3><canvas id="expensePieChartCanvas"></canvas><p id="expensePieChartCanvas-nodata" class="text-gray-500" style="display:none;">No data available</p></div><div class="chart-wrapper"><h3 class="text-xl font-semibold text-gray-700 mb-4 self-start">Income Sources</h3><canvas id="incomePieChartCanvas"></canvas><p id="incomePieChartCanvas-nodata" class="text-gray-500" style="display:none;">No data available</p></div></div>`;
            const timeSeriesData = generateTimeSeriesChartDataJS(); const expensePieData = generatePieChartDataJS('expense'); const incomePieData = generatePieChartDataJS('income');
            const createOrUpdateChart = (instance, canvasId, noDataId, type, data, options) => {
                const canvas = document.getElementById(canvasId); const noDataEl = document.getElementById(noDataId);
                if (!canvas || !noDataEl) return null;
                if (instance) instance.destroy();
                if (!data || !data.labels || data.labels.length === 0) { canvas.style.display = 'none'; noDataEl.style.display = 'block'; return null; }
                else { canvas.style.display = 'block'; noDataEl.style.display = 'none'; }
                try { return new Chart(canvas.getContext('2d'), { type, data, options }); } catch (e) { console.error("Chart.js error:", e); noDataEl.textContent = "Error rendering chart."; noDataEl.style.display = 'block'; canvas.style.display = 'none'; return null; }
            };
            const commonPieOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } };
            const commonLineOpts = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'top' } } };
            timeSeriesChartInstance = createOrUpdateChart(timeSeriesChartInstance, 'timeSeriesChartCanvas', 'timeSeriesChartCanvas-nodata', 'line', timeSeriesData, commonLineOpts);
            expensePieChartInstance = createOrUpdateChart(expensePieChartInstance, 'expensePieChartCanvas', 'expensePieChartCanvas-nodata', 'pie', expensePieData, commonPieOpts);
            incomePieChartInstance = createOrUpdateChart(incomePieChartInstance, 'incomePieChartCanvas', 'incomePieChartCanvas-nodata', 'pie', incomePieData, commonPieOpts);
        }
        function renderAddTransactionPage() {
            const section = document.getElementById('add-transaction-page-section'); if (!section) return;
            section.innerHTML = `<div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow"><h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Transaction</h2><div id="add-page-form-container"></div></div>`;
            renderTransactionForm('add-page-form-container', {}, false, (data) => { addTransaction(data); setActiveTab('transactions'); }, () => setActiveTab('dashboard'));
        }

        function renderTransactionForm(containerId, initialValues = {}, isEdit = false, onSave, onCancel) {
            const formContainer = document.getElementById(containerId);
            if (!formContainer) { console.error("FORM_ERROR: Container not found:", containerId); return; }
            console.log(`RENDER_FORM: Container: ${containerId}, Edit: ${isEdit}, Initial:`, JSON.parse(JSON.stringify(initialValues)));

            let type = initialValues.type || 'expense';
            let amount = initialValues.amount?.toString() || '';
            let description = initialValues.description || '';
            let category = initialValues.category || (type === 'income' ? incomeCategories[0] : expenseCategories[0]);
            let date = initialValues.date ? getISODate(initialValues.date) : getISODate(new Date());
            let errors = {};
            
            const rerenderLocalForm = () => { 
                console.log(`FORM_RERENDER (${containerId}): Type: ${type}, Amount: ${amount}, Cat: ${category}, Date: ${date}`);
                const categoriesForCurrentType = type === 'income' ? incomeCategories : expenseCategories;
                if (!categoriesForCurrentType.includes(category)) category = categoriesForCurrentType[0];
                const formIdPrefix = containerId.replace(/[^a-zA-Z0-9_]/g, '_');

                formContainer.innerHTML = `
                    <form class="transaction-form-dynamic-class space-y-4" novalidate>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Type</label><div class="flex rounded-md overflow-hidden"><button type="button" class="form-type-income flex-1 py-2 px-4 text-sm font-medium ${type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Income</button><button type="button" class="form-type-expense flex-1 py-2 px-4 text-sm font-medium ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Expense</button></div></div>
                        <div><label for="${formIdPrefix}-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">₹</span></div><input type="number" id="${formIdPrefix}-amount" value="${amount}" class="form-input pl-7 pr-12 ${errors.amount ? 'border-red-500' : ''}" placeholder="0.01" step="0.01" min="0.01"></div>${errors.amount ? `<p class="mt-1 text-sm text-red-600">${errors.amount}</p>` : ''}</div>
                        <div><label for="${formIdPrefix}-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><input type="text" id="${formIdPrefix}-description" value="${description}" class="form-input ${errors.description ? 'border-red-500' : ''}" placeholder="Enter description">${errors.description ? `<p class="mt-1 text-sm text-red-600">${errors.description}</p>` : ''}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="${formIdPrefix}-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label><select id="${formIdPrefix}-category" class="form-select ${errors.category ? 'border-red-500' : ''}">${categoriesForCurrentType.map(cat => `<option value="${cat}" ${category === cat ? 'selected' : ''}>${String(cat).charAt(0).toUpperCase() + String(cat).slice(1).replace('-', ' ')}</option>`).join('')}</select>${errors.category ? `<p class="mt-1 text-sm text-red-600">${errors.category}</p>` : ''}</div><div><label for="${formIdPrefix}-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="${formIdPrefix}-date" value="${date}" class="form-input ${errors.date ? 'border-red-500' : ''}" max="${getISODate(new Date())}">${errors.date ? `<p class="mt-1 text-sm text-red-600">${errors.date}</p>` : ''}</div></div>
                        <div class="flex justify-end space-x-3 pt-2">${onCancel ? `<button type="button" class="form-cancel-btn button button-secondary">Cancel</button>` : ''}<button type="submit" class="button button-primary">${isEdit ? 'Update' : 'Add'} Transaction</button></div>
                    </form>`;

                const currentFormEl = formContainer.querySelector('.transaction-form-dynamic-class');
                if (!currentFormEl) { console.error("FORM_ERROR: Dynamic form element not found after render."); return; }

                const typeIncomeBtn = currentFormEl.querySelector('.form-type-income');
                const typeExpenseBtn = currentFormEl.querySelector('.form-type-expense');
                
                if (typeIncomeBtn) typeIncomeBtn.addEventListener('click', () => { type = 'income'; rerenderLocalForm(); });
                if (typeExpenseBtn) typeExpenseBtn.addEventListener('click', () => { type = 'expense'; rerenderLocalForm(); });
                
                if (onCancel) { const cancelBtn = currentFormEl.querySelector('.form-cancel-btn'); if (cancelBtn) cancelBtn.addEventListener('click', onCancel); }
                
                const submitListener = (e) => {
                    e.preventDefault();
                    console.log(`FORM_SUBMIT (${containerId}): Triggered.`);
                    errors = {}; 
                    // Always read fresh from DOM at submit time
                    const amountInputEl = currentFormEl.querySelector(`#${formIdPrefix}-amount`);
                    const descriptionInputEl = currentFormEl.querySelector(`#${formIdPrefix}-description`);
                    const categorySelectEl = currentFormEl.querySelector(`#${formIdPrefix}-category`);
                    const dateInputEl = currentFormEl.querySelector(`#${formIdPrefix}-date`);

                    const submittedAmount = amountInputEl ? amountInputEl.value : '';
                    const submittedDescription = descriptionInputEl ? descriptionInputEl.value : '';
                    const submittedCategory = categorySelectEl ? categorySelectEl.value : '';
                    const submittedDate = dateInputEl ? dateInputEl.value : '';
                    const submittedType = type; 

                    console.log("FORM_SUBMIT_VALUES:", { submittedAmount, submittedDescription, submittedCategory, submittedDate, submittedType });

                    if (!submittedAmount || isNaN(Number(submittedAmount)) || Number(submittedAmount) <= 0) errors.amount = 'Valid amount > 0 required.';
                    if (!submittedDescription.trim()) errors.description = 'Description required.';
                    if (!submittedCategory) errors.category = 'Category required.';
                    if (!submittedDate) errors.date = 'Date required.';
                    else if (new Date(submittedDate + 'T00:00:00Z') > new Date()) errors.date = 'Date cannot be in the future.';

                    if (Object.keys(errors).length === 0) {
                        const dataToSave = { amount: Number(submittedAmount), description: submittedDescription, category: submittedCategory, type: submittedType, date: getISODate(submittedDate) };
                        console.log(`FORM_SUBMIT_SUCCESS (${containerId}): Validation OK. Data:`, JSON.parse(JSON.stringify(dataToSave)));
                        onSave(dataToSave);
                    } else {
                        console.log(`FORM_SUBMIT_FAIL (${containerId}): Validation errors:`, JSON.parse(JSON.stringify(errors)));
                        amount = submittedAmount; description = submittedDescription; category = submittedCategory; date = submittedDate;
                        rerenderLocalForm(); 
                    }
                };
                
                if (currentFormEl._submitListenerAttached) currentFormEl.removeEventListener('submit', currentFormEl._submitListenerAttached);
                currentFormEl.addEventListener('submit', submitListener);
                currentFormEl._submitListenerAttached = submitListener;
            };
            rerenderLocalForm(); 
        }

        function openTransactionFormModal(initialData = null, editMode = false) {
            console.log("OPEN_MODAL_FORM: EditMode:", editMode, "InitialData:", JSON.parse(JSON.stringify(initialData || {})));
            const modal = document.getElementById('transaction-form-modal');
            const modalFormHostElementId = 'transaction-form-modal-content';

            globalFormInitialValues = initialData || {};
            globalFormIsEdit = editMode;
            
            renderTransactionForm(
                modalFormHostElementId, 
                globalFormInitialValues,
                globalFormIsEdit,
                (data) => { 
                    if (globalFormIsEdit && globalFormInitialValues.id) {
                        updateTransaction(globalFormInitialValues.id, data);
                    } else {
                        addTransaction(data);
                    }
                },
                () => closeTransactionFormModal()
            );
            if (modal) modal.style.display = 'flex';
        }

        function closeTransactionFormModal() {
            console.log("CLOSE_MODAL_FORM");
            const modal = document.getElementById('transaction-form-modal');
            if (modal) modal.style.display = 'none';
            const modalContentEl = document.getElementById('transaction-form-modal-content');
            if (modalContentEl) modalContentEl.innerHTML = ''; 
        }
        
        function renderTransactionList(containerId, transactionsToDisplay, isCompact = false) {
            const listContainer = document.getElementById(containerId);
            if (!listContainer) { console.error("LIST_ERROR: Container not found:", containerId); return; }
            console.log(`RENDER_LIST (${containerId}): Displaying ${transactionsToDisplay.length} transactions. Compact: ${isCompact}`);

            if (transactionsToDisplay.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No transactions to display. Add one to get started!</p>`;
                return;
            }
            
            const inlineEditFormContainerIdPrefix = 'edit-form-';
            const tableRowsHTML = transactionsToDisplay.map(t => {
                if (editingTransactionId === t.id && !isCompact) { 
                    return `<tr class="editing-row" data-id="${t.id}"><td colspan="5"><div id="${inlineEditFormContainerIdPrefix}${t.id}"></div></td></tr>`;
                }
                return `<tr class="hover:bg-gray-50 transition-colors duration-150" data-id="${t.id}"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(t.date)}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${getCategoryColorHex(t.category)}33; color: ${getCategoryColorHex(t.category)};">${String(t.category).charAt(0).toUpperCase() + String(t.category).slice(1).replace('-', ' ')}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}</td>${isCompact ? '' : `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="edit-btn text-blue-600 hover:text-blue-900 mr-4" data-id="${t.id}">Edit</button><button class="delete-btn text-red-600 hover:text-red-900" data-id="${t.id}">Delete</button></td>`}</tr>`;
            }).join('');

            listContainer.innerHTML = `<div class="overflow-x-auto bg-white rounded-lg shadow"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>${isCompact ? '' : `<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>`}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${tableRowsHTML}</tbody></table></div>`;

            if (!isCompact) {
                const transactionBeingEdited = transactionsToDisplay.find(t => t.id === editingTransactionId);
                if(editingTransactionId && transactionBeingEdited) {
                    const editFormContainer = document.getElementById(`${inlineEditFormContainerIdPrefix}${editingTransactionId}`);
                    if (editFormContainer) {
                         renderTransactionForm(`${inlineEditFormContainerIdPrefix}${editingTransactionId}`, transactionBeingEdited, true, 
                            (updatedData) => updateTransaction(editingTransactionId, updatedData),
                            () => { editingTransactionId = null; renderApp(); } 
                        );
                    } else { console.warn(`LIST_WARN: Edit form container ${inlineEditFormContainerIdPrefix}${editingTransactionId} not found for inline edit.`); }
                }
                listContainer.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => { editingTransactionId = e.currentTarget.dataset.id; console.log("EDIT_BTN_CLICK: Editing ID set to:", editingTransactionId); renderApp(); }));
                listContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id)));
            }
        }
        
        function renderTransactionFilter(containerId) {
            const filterContainer = document.getElementById(containerId); if (!filterContainer) return;
            let localFilters = { startDate: currentFilters.startDate, endDate: currentFilters.endDate, category: currentFilters.category, type: currentFilters.type };
            let isOpen = false; 
            const updateFilterUI = () => {
                const activeFilterCount = (currentFilters.startDate ? 1:0) + (currentFilters.endDate ? 1:0) + (currentFilters.category !== 'all' ? 1:0) + (currentFilters.type !== 'all' ? 1:0);
                filterContainer.innerHTML = `<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"><div class="relative"><button id="filter-toggle-btn" class="button button-secondary flex items-center w-full sm:w-auto justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>Filters ${activeFilterCount > 0 ? `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${activeFilterCount} Active</span>` : ''}</button>${isOpen ? `<div id="filter-dropdown" class="absolute z-20 mt-2 w-full sm:w-96 bg-white rounded-md shadow-lg p-4 border border-gray-200 left-0"><div class="grid grid-cols-1 gap-4 sm:grid-cols-2"><div><label for="filter-startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label><input type="date" id="filter-startDate" value="${localFilters.startDate}" class="form-input" max="${getISODate(new Date())}"></div><div><label for="filter-endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label><input type="date" id="filter-endDate" value="${localFilters.endDate}" class="form-input" max="${getISODate(new Date())}"></div><div><label for="filter-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label><select id="filter-category" class="form-select"><option value="all">All Categories</option>${allTransactionCategories.map(cat => `<option value="${cat}" ${localFilters.category === cat ? 'selected' : ''}>${String(cat).charAt(0).toUpperCase() + String(cat).slice(1).replace('-', ' ')}</option>`).join('')}</select></div><div><label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label><select id="filter-type" class="form-select"><option value="all">All Types</option><option value="income" ${localFilters.type === 'income' ? 'selected' : ''}>Income</option><option value="expense" ${localFilters.type === 'expense' ? 'selected' : ''}>Expense</option></select></div></div><div class="mt-4 flex justify-end space-x-2"><button id="filter-reset-btn" class="button button-secondary">Reset</button><button id="filter-apply-btn" class="button button-primary">Apply Filters</button></div></div>` : ''}</div><div class="relative flex-grow sm:flex-grow-0 sm:w-64"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div><input type="text" id="transaction-search-input" value="${currentFilters.searchTerm}" class="form-input pl-10 w-full" placeholder="Search..."></div><div class="flex space-x-2 self-start sm:self-center"><button id="sort-by-date-btn" class="button text-xs ${currentSort.by === 'date' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">Date ${currentSort.by === 'date' ? (currentSort.direction === 'asc' ? '↑' : '↓') : ''}</button><button id="sort-by-amount-btn" class="button text-xs ${currentSort.by === 'amount' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">Amount ${currentSort.by === 'amount' ? (currentSort.direction === 'asc' ? '↑' : '↓') : ''}</button></div></div>`;
                const filterToggleBtn = document.getElementById('filter-toggle-btn'); if (filterToggleBtn) filterToggleBtn.addEventListener('click', () => { isOpen = !isOpen; if (isOpen) localFilters = { startDate: currentFilters.startDate, endDate: currentFilters.endDate, category: currentFilters.category, type: currentFilters.type }; updateFilterUI(); });
                if (isOpen) {
                    const sDate = document.getElementById('filter-startDate'); const eDate = document.getElementById('filter-endDate'); const catSel = document.getElementById('filter-category'); const typeSel = document.getElementById('filter-type'); const applyBtn = document.getElementById('filter-apply-btn'); const resetBtn = document.getElementById('filter-reset-btn');
                    if(sDate) sDate.addEventListener('change', (e) => localFilters.startDate = e.target.value); if(eDate) eDate.addEventListener('change', (e) => localFilters.endDate = e.target.value); if(catSel) catSel.addEventListener('change', (e) => localFilters.category = e.target.value); if(typeSel) typeSel.addEventListener('change', (e) => localFilters.type = e.target.value);
                    if(applyBtn) applyBtn.addEventListener('click', () => { if (localFilters.startDate && localFilters.endDate && localFilters.startDate > localFilters.endDate) { alert("Start date cannot be after end date."); return; } currentFilters = { ...currentFilters, ...localFilters }; isOpen = false; renderApp(); });
                    if(resetBtn) resetBtn.addEventListener('click', () => { localFilters = { startDate: '', endDate: '', category: 'all', type: 'all' }; currentFilters = { ...currentFilters, ...localFilters }; isOpen = false; renderApp(); });
                }
                const searchInput = document.getElementById('transaction-search-input'); const sortDateBtn = document.getElementById('sort-by-date-btn'); const sortAmountBtn = document.getElementById('sort-by-amount-btn');
                if(searchInput) searchInput.addEventListener('input', (e) => { currentFilters.searchTerm = e.target.value; renderApp(); });
                if(sortDateBtn) sortDateBtn.addEventListener('click', () => { if (currentSort.by === 'date') currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; else { currentSort.by = 'date'; currentSort.direction = 'desc'; } renderApp(); });
                if(sortAmountBtn) sortAmountBtn.addEventListener('click', () => { if (currentSort.by === 'amount') currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; else { currentSort.by = 'amount'; currentSort.direction = 'desc'; } renderApp(); });
            };
            updateFilterUI(); 
        }
        function renderExportButton(containerId, transactionsToExport) {
            const exportContainer = document.getElementById(containerId); if (!exportContainer) return;
            const isDisabled = transactionsToExport.length === 0;
            exportContainer.innerHTML = `<button id="export-csv-btn" class="button ${isDisabled ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'} flex items-center" ${isDisabled ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Export CSV</button>`;
            const exportBtn = document.getElementById('export-csv-btn');
            if (exportBtn && !isDisabled) {
                exportBtn.addEventListener('click', () => {
                    if (transactionsToExport.length === 0) { console.warn("EXPORT_WARN: No transactions to export."); return; }
                    const header = Object.keys(transactionsToExport[0]).join(',');
                    const rows = transactionsToExport.map(t => Object.values(t).map(val => typeof val === 'string' ? `"${val.replace(/"/g, '""')}"` : val).join(','));
                    const csvContent = `${header}\n${rows.join('\n')}`;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a"); const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url); link.setAttribute("download", "transactions.csv");
                    link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                });
            }
        }

        // --- MAIN APP LOGIC & RENDERING ---
        function setActiveTab(tabName) {
            console.log("SET_ACTIVE_TAB: New tab:", tabName, "Previous tab:", activeTab);
            activeTab = tabName;
            editingTransactionId = null; 
            renderApp();
        }

        function renderApp() {
            console.log("RENDER_APP_START: Active Tab:", activeTab, "Transactions Count:", transactions.length);
            const mainContentContainer = document.getElementById('app-main-content');
            if (!mainContentContainer) { console.error("CRITICAL_ERROR: Main content container 'app-main-content' not found!"); return; }
            
            renderHeader(); 
            
            mainContentContainer.innerHTML = `
                <section id="dashboard-section" class="content-section space-y-8"></section>
                <section id="transactions-section" class="content-section space-y-6"></section>
                <section id="charts-section" class="content-section space-y-6"></section>
                <section id="add-transaction-page-section" class="content-section"></section>
            `;

            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            let activeSectionId = '';
            if (activeTab === 'dashboard') activeSectionId = 'dashboard-section';
            else if (activeTab === 'transactions') activeSectionId = 'transactions-section';
            else if (activeTab === 'charts') activeSectionId = 'charts-section';
            else if (activeTab === 'add-transaction-page') activeSectionId = 'add-transaction-page-section';
            
            const sectionElement = document.getElementById(activeSectionId);
            if (sectionElement) {
                sectionElement.classList.add('active');
                console.log("RENDER_APP_ROUTING: Rendering content for tab:", activeTab);
                if (activeTab === 'dashboard') renderDashboardPage();
                else if (activeTab === 'transactions') renderTransactionsPage();
                else if (activeTab === 'charts') renderChartsPage();
                else if (activeTab === 'add-transaction-page') renderAddTransactionPage();
            } else {
                console.error("RENDER_APP_ERROR: Active section element not found for ID:", activeSectionId);
            }
            renderFooter(); 
            console.log("RENDER_APP_END: Rendering complete for tab:", activeTab);
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM_CONTENT_LOADED: Initializing app.");
            renderApp();
            const modalElement = document.getElementById('transaction-form-modal');
            if (modalElement) {
                modalElement.addEventListener('click', function(event) {
                    if (event.target === this) { 
                        console.log("MODAL_CLICK_OUTSIDE: Closing modal.");
                        closeTransactionFormModal();
                    }
                });
            }
        });
    </script>
</body>
</html>
